

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Inferring Grids &mdash; Tools for Experiments Manual  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Live Plotting Qcodes Data" href="Live%20plotting%20qcodes%20data.html" />
    <link rel="prev" title="Basic Operation of DDH5 and Benchmarking" href="Basic%20operation%20of%20DDH5%20and%20benchmarking.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tools for Experiments Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../plottr/index.html">Plottr’s Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../labcore/index.html">Labcore’s Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instrumentserver/index.html">Instrumentserver’s Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Index Page</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples and Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#labcore">Labcore</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#plotrr">Plotrr</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Basic%20operation%20of%20DDH5%20and%20benchmarking.html">Basic Operation of DDH5 and Benchmarking</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Inferring Grids</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#The-problem:-inferring-grids">The problem: inferring grids</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Setting-up">Setting up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Inferring-grids-from-sweep-directions">Inferring grids from sweep directions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Irregular-grids">Irregular grids</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Incomplete-data">Incomplete data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Live%20plotting%20qcodes%20data.html">Live Plotting Qcodes Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="Simple%20Live%20plotting%20example%20with%20DDH5.html">Simple Live plotting example with DDH5</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tools for Experiments Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Examples and Guides</a> &raquo;</li>
        
      <li>Inferring Grids</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/examples/plottr/Inferring grids.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Inferring-Grids">
<h1>Inferring Grids<a class="headerlink" href="#Inferring-Grids" title="Permalink to this headline">¶</a></h1>
<section id="The-problem:-inferring-grids">
<h2>The problem: inferring grids<a class="headerlink" href="#The-problem:-inferring-grids" title="Permalink to this headline">¶</a></h2>
<p>When we acquire data we often do so point-by-point, or chunk-by-chunk. And in general it is not possible to know in advance what shape exactly the final data will have. For multi-dimensional data this means that we don’t always know on what kind of of grid the data lies, if any. That information, however, is important for a variety of tasks we would like to perform, such as slicing our data, or plotting projections of it. And we want to do all of these already when we don’t have the full data
set yet, i.e., while a data acquisition is still running.</p>
<p>Things would of course be much easier if a grid of the right shape was pre-allocated and then gradually filled. But most data saving is not done that way (like in qcodes, for example). For that reason, we look at a few ways on how to infer grids from tabular data, where data is saved row-by-row.</p>
</section>
<section id="Setting-up">
<h2>Setting up<a class="headerlink" href="#Setting-up" title="Permalink to this headline">¶</a></h2>
<p>These are the important imports and some tool. Execute this first.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> widget
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">plottr.data</span> <span class="kn">import</span> <span class="n">datadict</span> <span class="k">as</span> <span class="n">dd</span>
<span class="kn">from</span> <span class="nn">plottr.utils</span> <span class="kn">import</span> <span class="n">num</span>
<span class="kn">from</span> <span class="nn">plottr.utils.num</span> <span class="kn">import</span> <span class="n">_find_switches</span><span class="p">,</span> <span class="n">is_invalid</span>
<span class="kn">from</span> <span class="nn">plottr.plot.mpl</span> <span class="kn">import</span> <span class="n">ppcolormesh_from_meshgrid</span>


<span class="k">def</span> <span class="nf">plot_image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a grid as image. The arrays x, y, z need to be in meshgrid form.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;500px&#39;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="s1">&#39;500px&#39;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">_x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_x</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_x</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">_y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_y</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_y</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">z2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">z2</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_grid2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a grid as image and pcolormesh side by side. x, y, z need to be meshgrids.&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plot_image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ppcolormesh_from_meshgrid</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;800px&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="s1">&#39;400px&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="n">grid2d</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">grid2d</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.2</span>

    <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid2d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ipt</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">grid2d</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">ipt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid2d</span>


<span class="k">def</span> <span class="nf">gridpattern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_scale</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">noise</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">noise_scale</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">noise_scale</span><span class="p">)</span>

    <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">.5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">_y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ix</span><span class="o">%</span><span class="k">2</span> and iy%2) or (not ix%2 and not iy%2):
                <span class="n">zz</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="mf">0.1</span>

    <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span>


<span class="k">def</span> <span class="nf">find_and_plot_switches</span><span class="p">(</span><span class="o">**</span><span class="n">arrs</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">switches</span> <span class="o">=</span> <span class="n">_find_switches</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">switches</span><span class="p">,</span> <span class="n">axes</span>
</pre></div>
</div>
</div>
</section>
<section id="Inferring-grids-from-sweep-directions">
<h2>Inferring grids from sweep directions<a class="headerlink" href="#Inferring-grids-from-sweep-directions" title="Permalink to this headline">¶</a></h2>
<p>The main method we’ll be using to infer the grid is to look at systematics in the coordinates (the <em>independents</em>) of the data. Since our main focus is to look at measurements, we look at the way the coordinates are swept or rastered – this is by far the most common way how control parameters are changed in the lab.</p>
<p>Very commonly, we sweep over our coordinates in nested loops, which then naturally form a grid. Coordinates then typically look something like this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define two coordinate axes</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># make some fake data on a grid spanned by x and y</span>
<span class="c1"># internally, we use np.meshgrid(x, y, indexing=&#39;ij&#39;), which produces a grid</span>
<span class="c1"># as if we had looped over x and y, x being the outer loop.</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">gridpattern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># print the shapes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">zz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># plot the grid as image</span>
<span class="n">plot_image</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(21, 15) (21, 15) (21, 15)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f265f63d61f14e2eb5d5ede914d01853", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>When setting this up, we of course know exactly the shape, and we can do all operations like slicing, plotting, etc. right away, as shown above. (<strong>Note</strong>: to visualize the grid, the data is overlayed with a checker board pattern)</p>
<p>However, we might not have that information in the final data (or it could be that we didn’t finish the sweep, and we only have parts of the grid). The only thing we can rely on in the end, is the data. And if it’s stored in a tabular format, the shape information may be gone or incorrect.</p>
<p>We will start with flattened data, like:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x1d</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y1d</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">z1d</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>To reconstruct the grid, we can analyze the values of the coordinates that occur in the data. In general that can be tricky – you would need to look at all occuring values and then sort the data accordingly onto the grid formed by all coordinates found.</p>
<p>However, for the cases where grids are useful to start with, the experimenter will (hopefully!) have systematically swept over the coordinates (as we have done above, essentially). If the sweeps are monotonous, we can reconstruct grids simply using <code class="docutils literal notranslate"><span class="pre">np.reshape</span></code>. The only thing we need to figure out is the shape of the grid we want to make.</p>
<p>To do that, we can simply look at the evolution of the coordinates:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">find_and_plot_switches</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b422f7c51bea44aab97eb672fa70e952", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([ 14,  29,  44,  59,  74,  89, 104, 119, 134, 149, 164, 179, 194,
        209, 224, 239, 254, 269, 284, 299]),
 array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b02bb6e10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b02bb6bd0&gt;],
       dtype=object))
</pre></div></div>
</div>
<p>When we assume that sweep direction is monotonous, then we can simply count the number switches in direction (the period) to figure out how often an axis dimension is swept. The suspected switches are marked in red in the plot above.</p>
<p>From these periods it is then easy to get the shape: Here we see that <code class="docutils literal notranslate"><span class="pre">y</span></code> is repeated 21 times – that means 21 is the number of <code class="docutils literal notranslate"><span class="pre">x</span></code> values on the grid, and the total size divided by 21 is the number of <code class="docutils literal notranslate"><span class="pre">y</span></code> values.</p>
<p>This basic principle is in a function that guesses the grid shape – <code class="docutils literal notranslate"><span class="pre">plottr.utils.num.guess_grid_from_sweep_direction</span></code> –, which is automatically used in <code class="docutils literal notranslate"><span class="pre">plottr.data.datadict.datadict_to_meshgrid</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">guess_grid_from_sweep_direction</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;x&#39;, &#39;y&#39;] (21, 15)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_image</span><span class="p">(</span><span class="n">x1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">y1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">z1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2a1ec645c48641ea9235e8f14fcdb1b2", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>It’s important to note that order of course matters. Consider this example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">guess_grid_from_sweep_direction</span><span class="p">(</span><span class="n">not_really_x</span><span class="o">=</span><span class="n">y1d</span><span class="p">,</span> <span class="n">not_really_y</span><span class="o">=</span><span class="n">x1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;not_really_y&#39;, &#39;not_really_x&#39;] (21, 15)
</pre></div></div>
</div>
<p>The function that determines the grid shape gives us the correct answer – but now the roles of x and y are swapped, because <code class="docutils literal notranslate"><span class="pre">not_really_y</span></code> is now the outer loop. This is important to keep in mind when doing things programatically.</p>
</section>
<section id="Irregular-grids">
<h2>Irregular grids<a class="headerlink" href="#Irregular-grids" title="Permalink to this headline">¶</a></h2>
<p>You might have wondered why were looking at sweep patterns rather than unique values, which might be easier to analyze. The reason is that it’s entirely possible to have a well-defined grid even when the coordinates in each row/column are not repeating exactly.</p>
<section id="Noise">
<h3>Noise<a class="headerlink" href="#Noise" title="Permalink to this headline">¶</a></h3>
<p>One example is when the coordinate itself is subject to noise or other variations:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

<span class="c1"># steps are 0.5 on each coordinate -- add some noise on a scale that&#39;s somewhat smaller</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">gridpattern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noise_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># the data we&#39;ll get in practice is flattened again</span>
<span class="n">x1d</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y1d</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">z1d</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># plot coordinatates</span>
<span class="n">find_and_plot_switches</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "360776dd48ba41809f80cb2c637fe0c5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([ 8, 17, 26, 35]),
 array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b02a69d10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b02b09690&gt;],
       dtype=object))
</pre></div></div>
</div>
<p>It’s obvious that this data would be hard to sort back onto a grid by looking at actual values. But because the noise is less than the (intentional) variation between the coordinates, we can still infer the grid shape by identifying large switches:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">guess_grid_from_sweep_direction</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

<span class="n">plot_grid2d</span><span class="p">(</span><span class="n">x1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">y1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">z1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;x&#39;, &#39;y&#39;] (5, 9)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4660a4e8af22400ca253a4cba801f612", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>The left plot shows the grid plotted as image, whereas a the right is showing a more accurate representation where the coordinates are moved by the added noise.</p>
</section>
<section id="Adaptive-measurements">
<h3>Adaptive measurements<a class="headerlink" href="#Adaptive-measurements" title="Permalink to this headline">¶</a></h3>
<p>Another example where irregular grids can occur is an adaptive sweep, where the coordinates in one dimension depend on the values of another. A simple, artificial example, we again look at an image of the grid and also the ‘real’ representation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="c1"># we&#39;re stretching the grid a bit, depending on the value of x</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>

<span class="c1"># mock data: a gaussian peak in 2D</span>
<span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plot_grid2d</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c92b5e3000484d8fb8d6a69b9c1e0b90", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>But of course, looking at switches still works.</p>
<p><strong>Note:</strong> When the distortion gets very bad, then it can become difficult to detect switches (when the magnitude of a switch is not much larger than the variations in the coordinate sweep). Then our method can fail.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x1d</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y1d</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">z1d</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">find_and_plot_switches</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "80d52793a21d4ffbbcd999443670c210", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([ 10,  21,  32,  43,  54,  65,  76,  87,  98, 109]),
 array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b0288f110&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7f3b028422d0&gt;],
       dtype=object))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">guess_grid_from_sweep_direction</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

<span class="n">plot_grid2d</span><span class="p">(</span><span class="n">x1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">y1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">z1d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;x&#39;, &#39;y&#39;] (11, 11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "655538921d654e6c80488b7f80ec3166", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
<section id="Incomplete-data">
<h2>Incomplete data<a class="headerlink" href="#Incomplete-data" title="Permalink to this headline">¶</a></h2>
<p>An important task is gridding of data where the target grid hasn’t been fully filled. This arises, for example, when a measurement is still ongoing, or has been aborted before finishing. Then, the size of the data is generally not readily suited for reshaping.</p>
<p>In this case we have implemented functionality to ‘pad’ the data such that a grid is possible again. To do that we find the smallest possible grid that encloses the data, fill the data with NaN, and then reshape. To make our life a bit easier, we use the DataDict format which has tools for this.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define two coordinate axes</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># make some fake data on a grid spanned by x and y</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">gridpattern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># print the full shapes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full shapes:&quot;</span><span class="p">,</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">zz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># now make flattened data where some entries are missing at the end</span>
<span class="n">nmissing</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x1d</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="o">-</span><span class="n">nmissing</span><span class="p">]</span>
<span class="n">y1d</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="o">-</span><span class="n">nmissing</span><span class="p">]</span>
<span class="n">z1d</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="o">-</span><span class="n">nmissing</span><span class="p">]</span>

<span class="c1"># note: we can still find the grid!</span>
<span class="n">order</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">guess_grid_from_sweep_direction</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid shape of the incomplete data:&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

<span class="c1"># reconstruct the correct grid</span>
<span class="c1"># to do so we use the datadict format and its convenience tools:</span>
<span class="n">data1d</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">DataDict</span><span class="p">(</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">x1d</span><span class="p">),</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">y1d</span><span class="p">),</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">z1d</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># guessing the grid, padding, and reshaping is all automatic here</span>
<span class="n">data2d</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">datadict_to_meshgrid</span><span class="p">(</span><span class="n">data1d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DataDict shape:&quot;</span><span class="p">,</span> <span class="n">data2d</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>

<span class="c1"># plot the grid</span>
<span class="n">plot_image</span><span class="p">(</span><span class="n">data2d</span><span class="o">.</span><span class="n">data_vals</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">data2d</span><span class="o">.</span><span class="n">data_vals</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">data2d</span><span class="o">.</span><span class="n">data_vals</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Full shapes: (21, 15) (21, 15) (21, 15)
Grid shape of the incomplete data: (15, 15)
DataDict shape: (15, 15)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cc55bf52a829458aabb5f23d569d483d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Live%20plotting%20qcodes%20data.html" class="btn btn-neutral float-right" title="Live Plotting Qcodes Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Basic%20operation%20of%20DDH5%20and%20benchmarking.html" class="btn btn-neutral float-left" title="Basic Operation of DDH5 and Benchmarking" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Wolfgang Pfaff, Marcos Frenkel.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>